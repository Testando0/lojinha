<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkMarket Painel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- CSS TEMA DARK --- */
        :root { 
            --bg-color: #121212; 
            --sidebar-bg: #1a1a1a;
            --card-bg: #1e1e1e; 
            --text-color: #e0e0e0; 
            --primary: #bb86fc; 
            --secondary: #03dac6; 
            --danger: #cf6679; 
            --input-bg: #2d2d2d; 
            --star: #ffd700; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; }
        
        /* LAYOUT DASHBOARD */
        .app-container { display: flex; width: 100%; height: 100%; }
        
        /* SIDEBAR (MENU LATERAL) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: 0.3s;
        }
        .logo { font-size: 1.5rem; color: var(--primary); font-weight: bold; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-items { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        .menu-btn {
            background: transparent;
            border: none;
            color: #aaa;
            text-align: left;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }
        .menu-btn:hover, .menu-btn.active { background: rgba(187, 134, 252, 0.1); color: var(--primary); }
        .menu-btn i { width: 20px; text-align: center; }

        /* ÁREA PRINCIPAL */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* BARRA DE PESQUISA */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .search-box {
            display: flex;
            align-items: center;
            background: var(--input-bg);
            border-radius: 20px;
            padding: 5px 15px;
            width: 300px;
            border: 1px solid #444;
        }
        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            color: white;
            margin: 0;
            padding: 8px;
        }
        .search-box i { color: #888; }

        /* ELEMENTOS GERAIS */
        .hidden { display: none !important; }
        button.action-btn { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        button.action-btn:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--primary); color: #000; }
        .btn-sec { background-color: var(--secondary); color: #000; }
        .btn-danger { background-color: var(--danger); color: #fff; }

        input, textarea, select { width: 100%; padding: 10px; margin: 10px 0; background-color: var(--input-bg); border: 1px solid #444; color: #fff; border-radius: 4px; }

        /* GRID PRODUTOS */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .product-card { background-color: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; display: flex; flex-direction: column; transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .product-img { width: 100%; height: 180px; object-fit: cover; cursor: pointer; }
        .product-info { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .price { color: var(--secondary); font-size: 1.2rem; font-weight: bold; margin: 5px 0; }
        .rating-badge { background: #333; color: var(--star); padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; display: inline-block; margin-bottom: 5px;}

        /* AUTH SCREENS (Centralizadas) */
        .auth-container {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg-color); z-index: 200;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-box { width: 100%; max-width: 400px; background: var(--card-bg); padding: 30px; border-radius: 10px; border: 1px solid #333; }

        /* MODAL */
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 300; overflow-y: auto; padding: 20px; display: flex; justify-content: center; align-items: start; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 10px; max-width: 600px; width: 100%; margin-top: 50px; position: relative; border: 1px solid var(--primary); }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--danger); }
        .review-box { background: #252525; padding: 10px; margin-top: 10px; border-radius: 5px; border-left: 3px solid var(--secondary); }
        
        /* Loading */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; z-index: 999; font-size: 1.5rem; }

        /* Responsivo */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; flex-direction: row; align-items: center; padding: 10px; height: auto; }
            .menu-items { flex-direction: row; overflow-x: auto; }
            .logo { margin-bottom: 0; margin-right: 20px; font-size: 1.2rem; }
            .menu-btn span { display: none; } /* Esconde texto no mobile, mostra só ícone */
        }
    </style>
</head>
<body>

    <div id="loading" class="hidden">Conectando à Nuvem...</div>

    <div id="auth-layer" class="auth-container">
        
        <div id="login-screen" class="auth-box">
            <h2 style="text-align:center; color:var(--primary); margin-bottom:20px">DarkMarket Login</h2>
            <input type="text" id="l-user" placeholder="Usuário">
            <input type="password" id="l-pass" placeholder="Senha">
            <button onclick="doLogin()" class="action-btn btn-primary" style="width:100%; margin-top:10px">Entrar</button>
            <p onclick="toggleAuth()" style="margin-top:15px; cursor:pointer; color:var(--secondary); text-align:center">Não tem conta? Cadastre-se</p>
        </div>

        <div id="register-screen" class="auth-box hidden">
            <h2 style="text-align:center; margin-bottom:20px">Criar Conta</h2>
            <input type="text" id="r-user" placeholder="Nome de Usuário">
            <input type="password" id="r-pass" placeholder="Senha">
            
            <div style="margin: 15px 0; display: flex; align-items: center; gap: 10px; background:#252525; padding:10px; border-radius:5px">
                <input type="checkbox" id="r-is-seller" onchange="toggleSellerFields()" style="width: 20px; height: 20px; margin: 0;">
                <label for="r-is-seller" style="cursor: pointer;">Quero Vender Produtos</label>
            </div>

            <div id="seller-fields" class="hidden" style="border-left: 2px solid var(--primary); padding-left: 10px;">
                <small style="color: #aaa;">Dados para receber pagamentos:</small>
                <input type="text" id="r-pix" placeholder="Chave PIX">
                <input type="text" id="r-wpp" placeholder="WhatsApp (Ex: 5511999999999)">
            </div>

            <button onclick="doRegister()" class="action-btn btn-sec" style="width:100%; margin-top:10px">Cadastrar</button>
            <p onclick="toggleAuth()" style="margin-top:15px; cursor:pointer; color:var(--secondary); text-align:center">Voltar para Login</p>
        </div>
    </div>

    <div id="app-main" class="app-container hidden">
        
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-skull"></i> DarkMarket
            </div>
            <nav class="menu-items">
                <button onclick="renderScreen('shop')" class="menu-btn active" id="nav-shop">
                    <i class="fas fa-store"></i> <span>Loja</span>
                </button>
                <button onclick="renderScreen('sell')" class="menu-btn hidden" id="nav-sell">
                    <i class="fas fa-tags"></i> <span>Anunciar</span>
                </button>
                <div style="flex:1"></div> <button onclick="logout()" class="menu-btn" style="color:var(--danger)">
                    <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
                </button>
            </nav>
        </aside>

        <main class="main-content">
            
            <div class="top-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Buscar produtos..." onkeyup="searchProducts()">
                </div>
                <div style="display:flex; align-items:center; gap:10px">
                    <span id="user-display" style="font-weight:bold; color:var(--primary)"></span>
                    <button onclick="loadDataCloud()" class="action-btn btn-sec" style="padding:5px 10px; font-size:0.8rem"><i class="fas fa-sync"></i></button>
                </div>
            </div>

            <div id="shop-screen" class="screen-section">
                <h2 style="margin-bottom:15px">Produtos Disponíveis</h2>
                <div id="products-list" class="products-grid"></div>
            </div>

            <div id="sell-screen" class="screen-section hidden">
                <h2 style="margin-bottom:15px">Novo Anúncio</h2>
                <div style="background:var(--card-bg); padding:20px; border-radius:10px; max-width:600px">
                    <input type="text" id="p-name" placeholder="Nome do Produto">
                    <input type="text" id="p-img" placeholder="URL da Imagem">
                    <input type="number" id="p-price" placeholder="Preço (R$)">
                    <textarea id="p-desc" placeholder="Descrição Detalhada" rows="5"></textarea>
                    <button onclick="postProduct()" class="action-btn btn-primary" style="width:100%">Publicar Produto</button>
                </div>
            </div>

        </main>
    </div>

    <div id="product-modal" class="hidden">
        <div id="modal-overlay" onclick="closeModal(event)">
            <div class="modal-content">
                <span class="close-modal" onclick="document.getElementById('product-modal').classList.add('hidden')">&times;</span>
                <div id="modal-body"></div>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIG JSONBIN =================
        const BIN_ID = '691ab4a143b1c97be9b262b4'; 
        const API_KEY = '$2a$10$A5x.MiQYJZrXPO9rQ6OfXeOnX7Hvz2JMcb5ZJS78vGK8D3RJoVejy'; 
        const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        // ==================================================

        let globalData = { users: [], products: [] };
        let currentUser = null;

        // --- REDE ---
        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
                if(!res.ok) throw new Error("Erro API");
                const json = await res.json();
                globalData = json.record;
                if(!globalData.users) globalData.users = [];
                if(!globalData.products) globalData.products = [];
            } catch (e) { console.error(e); } 
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        async function saveData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                await fetch(URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(globalData)
                });
            } catch (e) { alert("Erro ao salvar!"); }
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        // --- STARTUP ---
        function init() {
            const savedUser = sessionStorage.getItem('darkUser');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                enterApp();
            }
        }

        function enterApp() {
            document.getElementById('auth-layer').classList.add('hidden');
            document.getElementById('app-main').classList.remove('hidden');
            document.getElementById('user-display').innerText = `Olá, ${currentUser.user}`;
            
            // Configura Sidebar
            if(currentUser.role === 'seller') {
                document.getElementById('nav-sell').classList.remove('hidden');
            }

            loadDataCloud();
        }

        // --- BUSCA (LUPA) ---
        function searchProducts() {
            const term = document.getElementById('search-input').value.toLowerCase();
            // Filtra os produtos
            const filtered = globalData.products.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.desc.toLowerCase().includes(term)
            );
            // Renderiza apenas os filtrados
            renderProducts(filtered);
        }

        // --- AUTH ---
        function toggleSellerFields() {
            const isSeller = document.getElementById('r-is-seller').checked;
            const fields = document.getElementById('seller-fields');
            isSeller ? fields.classList.remove('hidden') : fields.classList.add('hidden');
        }

        function toggleAuth() {
            document.getElementById('login-screen').classList.toggle('hidden');
            document.getElementById('register-screen').classList.toggle('hidden');
        }

        async function doRegister() {
            const user = document.getElementById('r-user').value;
            const pass = document.getElementById('r-pass').value;
            const isSeller = document.getElementById('r-is-seller').checked;
            
            if(!user || !pass) return alert("Preencha tudo!");
            
            let pix = "", wpp = "";
            if (isSeller) {
                pix = document.getElementById('r-pix').value;
                wpp = document.getElementById('r-wpp').value;
                if(!pix || !wpp) return alert("Vendedor precisa de PIX e Whats!");
            }

            await fetchData();
            if(globalData.users.find(u => u.user === user)) return alert("Usuário existe!");

            globalData.users.push({ user, pass, role: isSeller ? 'seller' : 'buyer', pix, wpp });
            await saveData();
            alert("Cadastrado!");
            toggleAuth();
        }

        async function doLogin() {
            const user = document.getElementById('l-user').value;
            const pass = document.getElementById('l-pass').value;
            await fetchData();
            const found = globalData.users.find(u => u.user === user && u.pass === pass);
            if(found) {
                currentUser = found;
                if(!currentUser.role) currentUser.role = (currentUser.pix) ? 'seller' : 'buyer';
                sessionStorage.setItem('darkUser', JSON.stringify(currentUser));
                enterApp();
            } else {
                alert("Erro no login");
            }
        }

        function logout() {
            sessionStorage.clear();
            window.location.reload();
        }

        // --- CORE ---
        async function loadDataCloud() {
            await fetchData();
            renderProducts(globalData.products); // Carrega todos inicialmente
        }

        async function postProduct() {
            const name = document.getElementById('p-name').value;
            const img = document.getElementById('p-img').value;
            const price = document.getElementById('p-price').value;
            const desc = document.getElementById('p-desc').value;

            if(!name || !price) return alert("Dados incompletos");

            await fetchData();
            globalData.products.push({
                id: Date.now(),
                seller: currentUser.user,
                pix: currentUser.pix,
                wpp: currentUser.wpp,
                name, img, price, desc, reviews: []
            });
            await saveData();
            alert("Publicado!");
            document.getElementById('p-name').value = "";
            renderScreen('shop');
        }

        // Modificado para aceitar lista (para busca funcionar)
        function renderProducts(list) {
            const container = document.getElementById('products-list');
            container.innerHTML = '';

            if(list.length === 0) {
                container.innerHTML = '<p style="color:#777; grid-column:1/-1; text-align:center">Nenhum produto encontrado.</p>';
                return;
            }

            list.forEach(p => {
                // Cálculo média estrelas
                const revs = p.reviews || [];
                let avg = 0;
                if(revs.length) avg = (revs.reduce((a,b)=>a+b.stars,0) / revs.length).toFixed(1);
                const starBadge = revs.length ? `<i class="fas fa-star" style="color:gold"></i> ${avg}` : 'Novo';

                container.innerHTML += `
                    <div class="product-card">
                        <img src="${p.img || 'https://via.placeholder.com/300'}" class="product-img" onclick="openDetails(${p.id})">
                        <div class="product-info">
                            <div style="display:flex; justify-content:space-between;">
                                <small style="color:#888">${p.seller}</small>
                                <span class="rating-badge">${starBadge}</span>
                            </div>
                            <h3>${p.name}</h3>
                            <p class="price">R$ ${p.price}</p>
                            <button onclick="openDetails(${p.id})" class="action-btn btn-primary" style="margin-top:auto">Ver Mais</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- MODAL & REVIEWS ---
        function openDetails(id) {
            const p = globalData.products.find(x => x.id == id);
            if(!p) return;
            
            const revs = p.reviews || [];
            let revsHtml = revs.length ? '' : '<p style="color:#666">Seja o primeiro a avaliar!</p>';
            revs.forEach(r => {
                revsHtml += `
                    <div class="review-box">
                        <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:#aaa">
                            <span>${r.user}</span> <span>${r.date}</span>
                        </div>
                        <div style="color:gold">${'★'.repeat(r.stars)}</div>
                        <p>${r.msg}</p>
                    </div>
                `;
            });

            const wppUrl = `https://wa.me/${p.wpp}?text=Olá, interesse no ${p.name}`;

            document.getElementById('modal-body').innerHTML = `
                <div style="display:flex; gap:20px; flex-wrap:wrap">
                    <img src="${p.img}" style="width:100%; max-height:300px; object-fit:contain; background:#000; border-radius:5px">
                    <div style="flex:1">
                        <h2 style="color:var(--primary)">${p.name}</h2>
                        <h3 class="price">R$ ${p.price}</h3>
                        <p style="margin:10px 0; line-height:1.4">${p.desc}</p>
                        <div style="display:flex; gap:10px; margin-top:20px">
                            <button class="action-btn btn-sec" onclick="prompt('Chave PIX:', '${p.pix}')"><i class="fas fa-qrcode"></i> Pagar PIX</button>
                            <button class="action-btn" style="background:#25D366; color:white" onclick="window.open('${wppUrl}')"><i class="fab fa-whatsapp"></i> Contatar</button>
                        </div>
                    </div>
                </div>
                <hr style="border:1px solid #333; margin:20px 0">
                <h3>Avaliações</h3>
                <div style="background:#2a2a2a; padding:15px; border-radius:5px; margin:10px 0">
                    <select id="rev-stars" style="margin-bottom:5px; width:auto"><option value="5">5 Estrelas</option><option value="4">4 Estrelas</option><option value="3">3 Estrelas</option><option value="2">2 Estrelas</option><option value="1">1 Estrela</option></select>
                    <input type="text" id="rev-msg" placeholder="Sua opinião...">
                    <button class="action-btn btn-primary" onclick="sendReview(${p.id})">Avaliar</button>
                </div>
                <div style="max-height:200px; overflow-y:auto">${revsHtml}</div>
            `;
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeModal(e) {
            if(e.target.id === 'modal-overlay') document.getElementById('product-modal').classList.add('hidden');
        }

        async function sendReview(pid) {
            const stars = parseInt(document.getElementById('rev-stars').value);
            const msg = document.getElementById('rev-msg').value;
            if(!msg) return alert("Escreva algo!");

            await fetchData();
            const idx = globalData.products.findIndex(x => x.id == pid);
            if(idx > -1) {
                if(!globalData.products[idx].reviews) globalData.products[idx].reviews = [];
                globalData.products[idx].reviews.unshift({ user: currentUser.user, stars, msg, date: new Date().toLocaleDateString() });
                await saveData();
                openDetails(pid); // recarrega modal
                searchProducts(); // atualiza fundo
            }
        }

        // UI SWITCHER
        function renderScreen(screenId) {
            document.getElementById('shop-screen').classList.add('hidden');
            document.getElementById('sell-screen').classList.add('hidden');
            
            document.getElementById(screenId+'-screen').classList.remove('hidden');

            // Atualiza classe active no menu
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-'+screenId)?.classList.add('active');

            if(screenId === 'shop') loadDataCloud();
        }

        init();
    </script>
</body>
</html>

