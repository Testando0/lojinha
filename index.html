<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkMarket Painel V3</title>
    <style>
        /* --- RESET E VARIAVEIS --- */
        :root {
            --bg-body: #121212;
            --bg-sidebar: #000000;
            --bg-card: #1e1e1e;
            --bg-input: #2d2d2d;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --text: #e0e0e0;
            --danger: #ff5555;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; outline: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text);
            height: 100vh; /* Ocupa toda a altura da tela */
            overflow: hidden; /* Impede rolagem na pagina inteira */
        }

        /* --- UTILITARIOS --- */
        .hidden { display: none !important; }
        
        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        
        .btn-fill { background: var(--primary); color: #000; padding: 10px 20px; }
        .btn-outline { background: transparent; border: 1px solid var(--secondary); color: var(--secondary); padding: 5px 10px; }
        
        input, textarea, select {
            width: 100%; padding: 12px; margin: 8px 0;
            background: var(--bg-input); border: 1px solid #444; color: white; border-radius: 5px;
        }

        /* --- LAYOUT GERAL (DASHBOARD) --- */
        #app-container {
            display: flex;
            height: 100%;
            width: 100%;
        }

        /* SIDEBAR (MENU LATERAL) */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0; /* N√£o deixa o menu encolher */
        }
        
        .brand { font-size: 1.4rem; color: var(--primary); font-weight: bold; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        
        .nav-btn {
            background: transparent;
            color: #aaa;
            padding: 15px;
            text-align: left;
            font-size: 1rem;
            border-radius: 8px;
            margin-bottom: 5px;
            display: flex; align-items: center; gap: 10px;
        }
        .nav-btn:hover, .nav-btn.active { background: #222; color: var(--primary); }

        /* CONTEUDO PRINCIPAL */
        .main-content {
            flex: 1; /* Ocupa o resto da tela */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Importante para o scroll interno */
        }

        /* TOPO (LUPA) */
        .top-header {
            padding: 15px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-wrapper {
            display: flex; align-items: center; background: var(--bg-input);
            border-radius: 20px; padding: 0 15px; width: 400px; border: 1px solid #444;
        }
        .search-wrapper input { border: none; background: transparent; margin: 0; padding: 10px; }

        /* AREA DE SCROLL DOS PRODUTOS */
        .scroll-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto; /* Barra de rolagem apenas aqui */
        }

        /* CARDS DE PRODUTO */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        
        .card {
            background: var(--bg-card); border: 1px solid #333;
            border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;
        }
        .card img { width: 100%; height: 180px; object-fit: cover; cursor: pointer; }
        .card-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .price-tag { font-size: 1.2rem; color: var(--secondary); font-weight: bold; margin: 5px 0; }

        /* --- TELAS DE LOGIN (OVERLAY) --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-box { width: 100%; max-width: 380px; background: var(--bg-card); padding: 30px; border-radius: 10px; border: 1px solid var(--primary); }

        /* --- MODAL --- */
        #modal-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: flex; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-body {
            background: var(--bg-card); width: 100%; max-width: 600px;
            padding: 20px; border-radius: 10px; border: 1px solid #555; margin-top: 40px; position: relative;
        }

        /* RESPONSIVO MOBILE */
        @media(max-width: 768px) {
            #app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; align-items: center; padding: 10px; }
            .nav-btn { padding: 8px; font-size: 0.9rem; }
            .brand { margin: 0; font-size: 1rem; margin-right: 10px;}
            .search-wrapper { width: 150px; }
        }
    </style>
</head>
<body>

    <div id="loading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:flex; justify-content:center; align-items:center; z-index:2000;" class="hidden">
        Carregando...
    </div>

    <div id="auth-overlay">
        <div id="login-box" class="auth-box">
            <h2 style="text-align:center; color:var(--primary)">Entrar</h2>
            <input type="text" id="l-user" placeholder="Usu√°rio">
            <input type="password" id="l-pass" placeholder="Senha">
            <button onclick="doLogin()" class="btn-fill" style="width:100%; margin-top:10px">Login</button>
            <p onclick="toggleAuthScreens()" style="text-align:center; margin-top:15px; color:var(--secondary); cursor:pointer">Criar conta</p>
        </div>

        <div id="register-box" class="auth-box hidden">
            <h2 style="text-align:center; color:var(--secondary)">Cadastro</h2>
            <input type="text" id="r-user" placeholder="Usu√°rio">
            <input type="password" id="r-pass" placeholder="Senha">
            
            <div style="margin:10px 0; background:#222; padding:10px; border-radius:5px">
                <input type="checkbox" id="r-is-seller" onchange="toggleSellerInputs()" style="width:auto; margin-right:10px">
                <label for="r-is-seller">Quero Vender</label>
            </div>
            
            <div id="seller-inputs" class="hidden">
                <input type="text" id="r-pix" placeholder="Chave PIX">
                <input type="text" id="r-wpp" placeholder="WhatsApp (com DDD)">
            </div>

            <button onclick="doRegister()" class="btn-fill" style="background:var(--secondary); width:100%">Cadastrar</button>
            <p onclick="toggleAuthScreens()" style="text-align:center; margin-top:15px; color:#aaa; cursor:pointer">Voltar</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
        <aside class="sidebar">
            <div class="brand">üíÄ DarkMarket</div>
            
            <button onclick="showSection('shop')" id="btn-shop" class="nav-btn active">
                üõí Loja
            </button>
            
            <button onclick="showSection('sell')" id="btn-sell" class="nav-btn hidden">
                üè∑Ô∏è Anunciar
            </button>

            <div style="flex:1"></div> <button onclick="logout()" class="nav-btn" style="color:var(--danger)">
                üö™ Sair
            </button>
        </aside>

        <main class="main-content">
            
            <header class="top-header">
                <div class="search-wrapper">
                    <span>üîç</span>
                    <input type="text" id="search-input" placeholder="Pesquisar produto..." onkeyup="runSearch()">
                </div>
                <div style="display:flex; align-items:center; gap:10px">
                    <span id="user-welcome" style="color:var(--primary); font-weight:bold"></span>
                    <button onclick="loadData()" class="btn-outline">‚Üª</button>
                </div>
            </header>

            <div class="scroll-area">
                
                <div id="section-shop">
                    <h2 style="margin-bottom:15px">Produtos Recentes</h2>
                    <div id="products-grid" class="grid"></div>
                </div>

                <div id="section-sell" class="hidden">
                    <h2>Criar An√∫ncio</h2>
                    <div style="background:var(--bg-card); padding:20px; max-width:500px; border-radius:8px; margin-top:10px">
                        <label>Nome do Produto</label>
                        <input type="text" id="p-name">
                        <label>URL da Imagem</label>
                        <input type="text" id="p-img">
                        <label>Pre√ßo (R$)</label>
                        <input type="number" id="p-price">
                        <label>Descri√ß√£o</label>
                        <textarea id="p-desc" rows="4"></textarea>
                        <button onclick="createProduct()" class="btn-fill" style="width:100%">Publicar</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-bg" class="hidden" onclick="if(event.target.id==='modal-bg') this.classList.add('hidden')">
        <div id="modal-content" class="modal-body">
            </div>
    </div>

    <script>
        // --- CONFIG ---
        const BIN_ID = '691ab4a143b1c97be9b262b4'; 
        const API_KEY = '$2a$10$A5x.MiQYJZrXPO9rQ6OfXeOnX7Hvz2JMcb5ZJS78vGK8D3RJoVejy'; 
        const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        let data = { users: [], products: [] };
        let user = null;

        // --- API ---
        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
                const json = await res.json();
                data = json.record || { users: [], products: [] };
                renderShop(data.products);
            } catch (e) { console.error(e); alert('Erro na rede'); }
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        async function saveData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                await fetch(URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(data)
                });
            } catch(e) { alert('Erro ao salvar'); }
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        // --- AUTH ---
        function init() {
            const saved = sessionStorage.getItem('darkUserV3');
            if(saved) {
                user = JSON.parse(saved);
                startApp();
            }
        }

        function toggleAuthScreens() {
            document.getElementById('login-box').classList.toggle('hidden');
            document.getElementById('register-box').classList.toggle('hidden');
        }

        function toggleSellerInputs() {
            const isSeller = document.getElementById('r-is-seller').checked;
            const div = document.getElementById('seller-inputs');
            isSeller ? div.classList.remove('hidden') : div.classList.add('hidden');
        }

        async function doRegister() {
            const u = document.getElementById('r-user').value;
            const p = document.getElementById('r-pass').value;
            const isSeller = document.getElementById('r-is-seller').checked;
            
            if(!u || !p) return alert('Preencha tudo');

            let pix='', wpp='';
            if(isSeller) {
                pix = document.getElementById('r-pix').value;
                wpp = document.getElementById('r-wpp').value;
                if(!pix || !wpp) return alert('Vendedores precisam de PIX e Zap');
            }

            await loadData();
            if(data.users.find(x => x.user === u)) return alert('Usu√°rio j√° existe');

            data.users.push({ user: u, pass: p, role: isSeller?'seller':'buyer', pix, wpp });
            await saveData();
            alert('Criado! Fa√ßa Login.');
            toggleAuthScreens();
        }

        async function doLogin() {
            const u = document.getElementById('l-user').value;
            const p = document.getElementById('l-pass').value;

            await loadData();
            const found = data.users.find(x => x.user === u && x.pass === p);
            
            if(found) {
                user = found;
                // Corre√ß√£o legado
                if(!user.role) user.role = user.pix ? 'seller' : 'buyer';
                sessionStorage.setItem('darkUserV3', JSON.stringify(user));
                startApp();
            } else {
                alert('Login errado');
            }
        }

        function logout() {
            sessionStorage.clear();
            window.location.reload();
        }

        function startApp() {
            document.getElementById('auth-overlay').classList.add('hidden'); // Esconde login
            document.getElementById('app-container').classList.remove('hidden'); // Mostra painel
            
            document.getElementById('user-welcome').innerText = user.user;

            if(user.role === 'seller') {
                document.getElementById('btn-sell').classList.remove('hidden');
            }

            loadData();
        }

        // --- NAVEGA√á√ÉO ---
        function showSection(sec) {
            // Esconde todos
            document.getElementById('section-shop').classList.add('hidden');
            document.getElementById('section-sell').classList.add('hidden');
            
            // Remove active dos botoes
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            // Mostra o escolhido
            document.getElementById('section-'+sec).classList.remove('hidden');
            document.getElementById('btn-'+sec).classList.add('active');
        }

        // --- LOJA E BUSCA ---
        function runSearch() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = data.products.filter(p => p.name.toLowerCase().includes(term) || p.desc.toLowerCase().includes(term));
            renderShop(filtered);
        }

        function renderShop(list) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            
            if(list.length === 0) {
                grid.innerHTML = '<p style="color:#666">Nenhum produto.</p>';
                return;
            }

            list.forEach(p => {
                // Media estrelas
                const revs = p.reviews || [];
                let avg = 0;
                if(revs.length) avg = (revs.reduce((a,b)=>a+b.stars,0) / revs.length).toFixed(1);
                const badge = revs.length ? `‚≠ê ${avg}` : 'Novo';

                grid.innerHTML += `
                    <div class="card">
                        <img src="${p.img}" onclick="openModal(${p.id})" onerror="this.src='https://via.placeholder.com/300'">
                        <div class="card-body">
                            <div style="display:flex; justify-content:space-between; color:#777; font-size:0.8rem">
                                <span>${p.seller}</span>
                                <span>${badge}</span>
                            </div>
                            <h3 style="margin:5px 0; color:white">${p.name}</h3>
                            <div class="price-tag">R$ ${p.price}</div>
                            <button class="btn-fill" style="margin-top:auto" onclick="openModal(${p.id})">Ver Detalhes</button>
                        </div>
                    </div>
                `;
            });
        }

        async function createProduct() {
            const name = document.getElementById('p-name').value;
            const img = document.getElementById('p-img').value;
            const price = document.getElementById('p-price').value;
            const desc = document.getElementById('p-desc').value;

            if(!name || !price) return alert('Preencha campos obrigat√≥rios');

            await loadData(); // Refresh antes de postar
            
            data.products.push({
                id: Date.now(),
                seller: user.user,
                pix: user.pix,
                wpp: user.wpp,
                name, img, price, desc, reviews: []
            });

            await saveData();
            alert('Publicado!');
            // Limpar form
            document.getElementById('p-name').value = '';
            showSection('shop');
            loadData();
        }

        // --- MODAL & AVALIA√á√ÉO ---
        function openModal(id) {
            const p = data.products.find(x => x.id == id);
            if(!p) return;

            const wppUrl = `https://wa.me/${p.wpp}?text=Ol√°, tenho interesse em ${p.name}`;
            
            // Render Reviews
            const revs = p.reviews || [];
            let revsHtml = revs.map(r => `
                <div style="background:#111; padding:10px; margin-bottom:5px; border-radius:5px; font-size:0.9rem">
                    <div style="color:gold">${'‚≠ê'.repeat(r.stars)} <span style="color:#777; margin-left:5px">- ${r.user}</span></div>
                    <div>${r.msg}</div>
                </div>
            `).join('');
            
            if(!revsHtml) revsHtml = '<p style="color:#555">Sem avalia√ß√µes ainda.</p>';

            document.getElementById('modal-content').innerHTML = `
                <button style="float:right; background:none; color:red; font-size:1.5rem" onclick="document.getElementById('modal-bg').classList.add('hidden')">√ó</button>
                
                <div style="display:flex; gap:20px; flex-wrap:wrap">
                    <img src="${p.img}" style="max-width:200px; border-radius:5px; object-fit:cover">
                    <div style="flex:1">
                        <h2 style="color:var(--primary)">${p.name}</h2>
                        <h3 style="color:var(--secondary)">R$ ${p.price}</h3>
                        <p style="color:#ccc; margin:10px 0">${p.desc}</p>
                        <br>
                        <button class="btn-outline" onclick="prompt('Chave PIX:', '${p.pix}')">üì≤ PIX</button>
                        <button class="btn-fill" style="background:#25D366; color:white" onclick="window.open('${wppUrl}')">üí¨ WhatsApp</button>
                    </div>
                </div>

                <hr style="border:1px solid #333; margin:20px 0">
                
                <h3>Avalia√ß√µes</h3>
                <div style="background:#222; padding:10px; border-radius:5px; margin:10px 0">
                    <select id="r-stars" style="width:100px"><option value="5">5 ‚≠ê</option><option value="4">4 ‚≠ê</option><option value="3">3 ‚≠ê</option><option value="2">2 ‚≠ê</option><option value="1">1 ‚≠ê</option></select>
                    <input id="r-msg" placeholder="Deixe sua opini√£o...">
                    <button class="btn-fill" onclick="sendReview(${p.id})">Enviar</button>
                </div>

                <div style="max-height:200px; overflow-y:auto">
                    ${revsHtml}
                </div>
            `;
            document.getElementById('modal-bg').classList.remove('hidden');
        }

        async function sendReview(pid) {
            const stars = parseInt(document.getElementById('r-stars').value);
            const msg = document.getElementById('r-msg').value;
            if(!msg) return alert('Escreva algo');

            await loadData(); // Puxa vers√£o mais nova
            const idx = data.products.findIndex(x => x.id == pid);
            if(idx > -1) {
                if(!data.products[idx].reviews) data.products[idx].reviews = [];
                data.products[idx].reviews.unshift({ user: user.user, stars, msg });
                await saveData();
                openModal(pid); // Recarrega modal com nova review
                runSearch(); // Atualiza grid de fundo
            }
        }

        init();
    </script>
</body>
</html>
