<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkMarket Online 2.0</title>
    <style>
        /* --- CSS TEMA DARK --- */
        :root { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --primary: #bb86fc; --secondary: #03dac6; --danger: #cf6679; --input-bg: #2d2d2d; --star: #ffd700; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 50px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; margin-top: 5px; }
        button:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--primary); color: #000; }
        .btn-sec { background-color: var(--secondary); color: #000; }
        .btn-danger { background-color: var(--danger); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid #555; color: #ddd; }

        input, textarea, select { width: 100%; padding: 10px; margin: 10px 0; background-color: var(--input-bg); border: 1px solid #444; color: #fff; border-radius: 4px; }
        
        /* Header */
        header { background-color: var(--card-bg); padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333; }
        .logo { font-size: 1.5rem; color: var(--primary); font-weight: bold; }
        
        /* Grid Produtos */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .product-card { background-color: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; display: flex; flex-direction: column; transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        .product-img { width: 100%; height: 200px; object-fit: cover; cursor: pointer; }
        .product-info { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .price { color: var(--secondary); font-size: 1.2rem; font-weight: bold; margin: 5px 0; }
        
        .rating-badge { background: #333; color: var(--star); padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; display: inline-block; margin-bottom: 5px;}

        .actions { margin-top: auto; display: flex; gap: 5px; }
        .btn-whatsapp { background-color: #25D366; color: white; flex: 1; }
        .btn-pix { background-color: #32BCAD; color: white; flex: 1; }

        /* Modal Detalhes */
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; overflow-y: auto; padding: 20px; display: flex; justify-content: center; align-items: start; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 10px; max-width: 600px; width: 100%; margin-top: 50px; position: relative; border: 1px solid var(--primary); }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--danger); }
        
        .review-box { background: #252525; padding: 10px; margin-top: 10px; border-radius: 5px; border-left: 3px solid var(--secondary); }
        .review-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .star-color { color: var(--star); }

        /* Loading overlay */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; z-index: 999; font-size: 1.5rem; }
    </style>
</head>
<body>

    <div id="loading" class="hidden">Carregando dados da Nuvem...</div>

    <header>
        <div class="logo">DarkMarket <span style="font-size:0.8rem; color:#777">(Online)</span></div>
        <nav id="nav-menu" class="hidden">
            <button onclick="renderScreen('shop')" class="btn-primary">Comprar</button>
            <button onclick="renderScreen('sell')" id="btn-sell-nav" class="btn-sec hidden">Vender</button>
            <button onclick="logout()" class="btn-danger">Sair</button>
        </nav>
    </header>

    <div id="login-screen" class="container">
        <div style="max-width:400px; margin:50px auto; background:var(--card-bg); padding:20px; border-radius:10px; text-align:center">
            <h2>Entrar</h2>
            <input type="text" id="l-user" placeholder="Usuário">
            <input type="password" id="l-pass" placeholder="Senha">
            <button onclick="doLogin()" class="btn-primary" style="width:100%">Login</button>
            <p onclick="toggleAuth()" style="margin-top:10px; cursor:pointer; color:var(--secondary)">Criar conta</p>
        </div>
    </div>

    <div id="register-screen" class="container hidden">
        <div style="max-width:400px; margin:50px auto; background:var(--card-bg); padding:20px; border-radius:10px;">
            <h2 style="text-align: center;">Cadastro</h2>
            <input type="text" id="r-user" placeholder="Nome de Usuário">
            <input type="password" id="r-pass" placeholder="Senha">
            
            <div style="margin: 15px 0; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="r-is-seller" onchange="toggleSellerFields()" style="width: 20px; height: 20px; margin: 0;">
                <label for="r-is-seller" style="cursor: pointer;">Quero cadastrar como Vendedor</label>
            </div>

            <div id="seller-fields" class="hidden" style="border-left: 2px solid var(--primary); padding-left: 10px;">
                <p style="font-size: 0.8rem; color: #aaa;">Dados para receber pagamentos:</p>
                <input type="text" id="r-pix" placeholder="Sua Chave PIX">
                <input type="text" id="r-wpp" placeholder="Seu WhatsApp (Ex: 5511999999999)">
            </div>

            <button onclick="doRegister()" class="btn-sec" style="width:100%">Cadastrar</button>
            <p onclick="toggleAuth()" style="margin-top:10px; cursor:pointer; color:var(--secondary); text-align: center;">Voltar para Login</p>
        </div>
    </div>

    <div id="shop-screen" class="container hidden">
        <h2>Loja Global</h2>
        <button onclick="loadDataCloud()" class="btn-outline" style="font-size:0.8rem;">↻ Atualizar Produtos</button>
        <div id="products-list" class="products-grid"></div>
    </div>

    <div id="sell-screen" class="container hidden">
        <h2>Anunciar Produto</h2>
        <div style="background:var(--card-bg); padding:20px; border-radius:10px">
            <input type="text" id="p-name" placeholder="Nome do Produto">
            <input type="text" id="p-img" placeholder="Link da Imagem (URL)">
            <input type="number" id="p-price" placeholder="Preço (R$)">
            <textarea id="p-desc" placeholder="Descrição detalhada"></textarea>
            <button onclick="postProduct()" class="btn-primary">Publicar Agora</button>
        </div>
    </div>

    <div id="product-modal" class="hidden">
        <div id="modal-overlay" onclick="closeModal(event)">
            <div class="modal-content">
                <span class="close-modal" onclick="document.getElementById('product-modal').classList.add('hidden')">&times;</span>
                <div id="modal-body">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIGURAÇÃO (JSONBIN) =================
        const BIN_ID = '691ab4a143b1c97be9b262b4'; 
        const API_KEY = '$2a$10$A5x.MiQYJZrXPO9rQ6OfXeOnX7Hvz2JMcb5ZJS78vGK8D3RJoVejy'; 
        const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        // ==========================================================

        let globalData = { users: [], products: [] };
        let currentUser = null;

        // --- REDE ---
        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
                if(!res.ok) throw new Error("Erro ao conectar");
                const json = await res.json();
                globalData = json.record;
                // Garantir arrays vazios se não existirem
                if(!globalData.users) globalData.users = [];
                if(!globalData.products) globalData.products = [];
            } catch (e) {
                console.error(e);
                alert("Erro de conexão.");
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function saveData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                await fetch(URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(globalData)
                });
            } catch (e) {
                alert("Erro ao salvar dados!");
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // --- AUTH & INICIALIZAÇÃO ---
        function init() {
            const savedUser = sessionStorage.getItem('darkUser');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('nav-menu').classList.remove('hidden');
                updateNavVisibility(); // Configura menu baseado na role
                loadDataCloud();
                renderScreen('shop');
            }
        }

        function updateNavVisibility() {
            const sellBtn = document.getElementById('btn-sell-nav');
            if (currentUser && currentUser.role === 'seller') {
                sellBtn.classList.remove('hidden');
            } else {
                sellBtn.classList.add('hidden');
            }
        }

        function toggleSellerFields() {
            const isSeller = document.getElementById('r-is-seller').checked;
            const fields = document.getElementById('seller-fields');
            if(isSeller) fields.classList.remove('hidden');
            else fields.classList.add('hidden');
        }

        async function doRegister() {
            const user = document.getElementById('r-user').value;
            const pass = document.getElementById('r-pass').value;
            const isSeller = document.getElementById('r-is-seller').checked;
            
            // Validação
            if(!user || !pass) return alert("Preencha usuário e senha!");
            
            let pix = "", wpp = "";
            if (isSeller) {
                pix = document.getElementById('r-pix').value;
                wpp = document.getElementById('r-wpp').value;
                if(!pix || !wpp) return alert("Vendedores precisam preencher PIX e WhatsApp!");
            }

            await fetchData();
            if(globalData.users.find(u => u.user === user)) return alert("Usuário já existe");

            const newUser = { 
                user, 
                pass, 
                role: isSeller ? 'seller' : 'buyer', 
                pix, 
                wpp 
            };

            globalData.users.push(newUser);
            await saveData();
            
            alert("Conta criada! Faça login.");
            toggleAuth();
        }

        async function doLogin() {
            const user = document.getElementById('l-user').value;
            const pass = document.getElementById('l-pass').value;

            await fetchData();
            const found = globalData.users.find(u => u.user === user && u.pass === pass);
            
            if(found) {
                currentUser = found;
                // Correção para usuários antigos que não tem role definida
                if(!currentUser.role) currentUser.role = (currentUser.pix && currentUser.pix.length > 0) ? 'seller' : 'buyer';
                
                sessionStorage.setItem('darkUser', JSON.stringify(currentUser));
                
                document.getElementById('nav-menu').classList.remove('hidden');
                updateNavVisibility();
                renderScreen('shop');
            } else {
                alert("Dados incorretos");
            }
        }

        function logout() {
            sessionStorage.clear();
            window.location.reload();
        }

        // --- LÓGICA DE PRODUTOS ---
        async function loadDataCloud() {
            await fetchData();
            renderProducts();
        }

        async function postProduct() {
            if(!currentUser || currentUser.role !== 'seller') return alert("Apenas vendedores podem anunciar.");
            
            const name = document.getElementById('p-name').value;
            const img = document.getElementById('p-img').value;
            const price = document.getElementById('p-price').value;
            const desc = document.getElementById('p-desc').value;

            if(!name || !price) return alert("Preencha nome e preço");

            await fetchData();

            globalData.products.push({
                id: Date.now(),
                seller: currentUser.user,
                pix: currentUser.pix,
                wpp: currentUser.wpp,
                name, img, price, desc,
                reviews: [] // Array para avaliações
            });

            await saveData();
            alert("Produto publicado!");
            document.getElementById('p-name').value = "";
            renderScreen('shop');
        }

        // --- RENDERIZAÇÃO ---
        function renderProducts() {
            const container = document.getElementById('products-list');
            container.innerHTML = '';

            globalData.products.forEach(p => {
                // Calcular média de estrelas
                const reviews = p.reviews || [];
                let avg = 0;
                if(reviews.length > 0) {
                    const sum = reviews.reduce((acc, curr) => acc + parseInt(curr.stars), 0);
                    avg = (sum / reviews.length).toFixed(1);
                }
                const starDisplay = reviews.length > 0 ? `★ ${avg} (${reviews.length})` : 'Sem avaliações';

                container.innerHTML += `
                    <div class="product-card">
                        <img src="${p.img || 'https://via.placeholder.com/300'}" class="product-img" onclick="openDetails(${p.id})">
                        <div class="product-info">
                            <div style="display:flex; justify-content:space-between;">
                                <small style="color:#888">${p.seller}</small>
                                <span class="rating-badge">${starDisplay}</span>
                            </div>
                            <h3>${p.name}</h3>
                            <p class="price">R$ ${p.price}</p>
                            <p style="color:#aaa; font-size:0.9rem; margin-bottom:10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${p.desc}
                            </p>
                            <div class="actions">
                                <button class="btn-primary" style="flex:1" onclick="openDetails(${p.id})">Ver Detalhes / Avaliar</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // --- DETALHES E AVALIAÇÃO ---
        function openDetails(productId) {
            // Busca produto na memória local (ja atualizada pelo fetchData anterior)
            const p = globalData.products.find(prod => prod.id == productId);
            if(!p) return;

            const modal = document.getElementById('product-modal');
            const body = document.getElementById('modal-body');
            
            // Tratar reviews
            const reviews = p.reviews || [];
            let reviewsHTML = '';
            if(reviews.length === 0) {
                reviewsHTML = '<p style="color:#777; font-style:italic">Nenhuma avaliação ainda.</p>';
            } else {
                reviews.forEach(r => {
                    const stars = '★'.repeat(r.stars) + '☆'.repeat(5 - r.stars);
                    reviewsHTML += `
                        <div class="review-box">
                            <div class="review-header">
                                <strong>${r.user}</strong>
                                <span>${r.date || ''}</span>
                            </div>
                            <div class="star-color">${stars}</div>
                            <p>${r.msg}</p>
                        </div>
                    `;
                });
            }

            const wppLink = `https://wa.me/${p.wpp}?text=Olá, vi seu anuncio ${p.name} no DarkMarket`;

            body.innerHTML = `
                <img src="${p.img || 'https://via.placeholder.com/600'}" style="width:100%; max-height:300px; object-fit:contain; background:#000; border-radius:5px">
                <h2 style="margin-top:15px; color:var(--primary)">${p.name}</h2>
                <p class="price">R$ ${p.price}</p>
                <p style="margin:15px 0; line-height:1.5">${p.desc}</p>
                
                <hr style="border:1px solid #333; margin:15px 0">
                
                <h3>Comprar</h3>
                <div class="actions">
                    <button class="btn-pix" onclick="prompt('Chave PIX do vendedor:', '${p.pix}')">Copiar PIX</button>
                    <button class="btn-whatsapp" onclick="window.open('${wppLink}')">Negociar no WhatsApp</button>
                </div>

                <hr style="border:1px solid #333; margin:20px 0">

                <h3>Avaliações</h3>
                
                <div style="background:#2d2d2d; padding:10px; border-radius:5px; margin-top:10px;">
                    <h4 style="margin-bottom:5px">Deixe sua avaliação:</h4>
                    <select id="new-review-stars" style="margin-bottom:5px">
                        <option value="5">★★★★★ (5)</option>
                        <option value="4">★★★★☆ (4)</option>
                        <option value="3">★★★☆☆ (3)</option>
                        <option value="2">★★☆☆☆ (2)</option>
                        <option value="1">★☆☆☆☆ (1)</option>
                    </select>
                    <input type="text" id="new-review-msg" placeholder="Escreva o que achou do produto...">
                    <button class="btn-sec" onclick="submitReview(${p.id})">Enviar Avaliação</button>
                </div>

                <div style="margin-top:20px; max-height:300px; overflow-y:auto">
                    ${reviewsHTML}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function closeModal(e) {
            if(e.target.id === 'modal-overlay') {
                document.getElementById('product-modal').classList.add('hidden');
            }
        }

        async function submitReview(productId) {
            const stars = document.getElementById('new-review-stars').value;
            const msg = document.getElementById('new-review-msg').value;

            if(!msg) return alert("Escreva uma mensagem para avaliar.");

            await fetchData(); // Atualiza antes de salvar
            
            // Encontra o produto no array global atualizado
            const prodIndex = globalData.products.findIndex(p => p.id == productId);
            if(prodIndex === -1) return alert("Produto não encontrado.");

            if(!globalData.products[prodIndex].reviews) globalData.products[prodIndex].reviews = [];

            globalData.products[prodIndex].reviews.unshift({
                user: currentUser.user,
                stars: parseInt(stars),
                msg: msg,
                date: new Date().toLocaleDateString()
            });

            await saveData();
            alert("Avaliação enviada!");
            
            // Recarrega o modal com os novos dados
            openDetails(productId); 
            // Atualiza a lista de fundo também para mostrar nova média
            renderProducts(); 
        }

        // --- UI ---
        function renderScreen(screen) {
            ['login-screen','register-screen','shop-screen','sell-screen'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(screen+'-screen').classList.remove('hidden');
            if(screen === 'shop') renderProducts();
        }

        function toggleAuth() {
            document.getElementById('login-screen').classList.toggle('hidden');
            document.getElementById('register-screen').classList.toggle('hidden');
        }

        init();

    </script>
</body>
</html>
