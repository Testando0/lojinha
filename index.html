<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkMarket Pro Mobile Fixed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"> 
    <style>
        /* (*** O CSS COMPLETO PERMANECE INALTERADO ***) */
        :root {
            --bg-body: #121212;
            --bg-sidebar: #1a1a1a;
            --bg-card: #252525;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --primary: #bb86fc; 
            --primary-hover: #9965f4;
            --accent: #03dac6; 
            --danger: #cf6679;
            --border: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; }
        
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* --- UTILIT√ÅRIOS --- */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        
        input, textarea { 
            width: 100%; padding: 12px; margin: 8px 0 15px; 
            background: #1e1e1e; border: 1px solid var(--border); 
            color: #fff; border-radius: 6px; outline: none;
        }
        input:focus, textarea:focus { border-color: var(--primary); }

        /* --- LOGIN & CADASTRO --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 1000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            background: var(--bg-card); padding: 40px; border-radius: 12px;
            width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center; border: 1px solid var(--border);
            max-height: 90vh; overflow-y: auto;
        }
        .auth-logo { font-size: 2rem; color: var(--primary); margin-bottom: 20px; font-weight: bold; letter-spacing: 1px; }

        /* --- LAYOUT SIDEBAR --- */
        aside {
            width: 260px; background: var(--bg-sidebar); height: 100%;
            display: flex; flex-direction: column; border-right: 1px solid var(--border);
            padding: 20px; transition: 0.3s;
        }
        
        .user-mini-profile {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;
            padding-bottom: 20px; border-bottom: 1px solid var(--border);
        }
        .avatar-circle {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--primary); margin-bottom: 10px; background: #333;
        }
        .user-name { font-weight: bold; font-size: 1.1rem; }
        .user-role { font-size: 0.85rem; color: var(--text-muted); }

        .nav-menu button {
            width: 100%; background: transparent; color: var(--text-muted);
            text-align: left; padding: 12px; margin-bottom: 5px; border-radius: 6px;
            display: flex; align-items: center; gap: 10px; font-size: 1rem;
        }
        .nav-menu button:hover, .nav-menu button.active {
            background: rgba(187, 134, 252, 0.1); color: var(--primary);
        }
        .nav-menu button i { width: 20px; text-align: center; }

        #btn-search-toggle {
            width: 100%; background: transparent; color: var(--text-muted);
            text-align: left; padding: 12px; margin-bottom: 5px; border-radius: 6px;
            display: flex; align-items: center; gap: 10px; font-size: 1rem;
            border: 1px solid var(--border); justify-content: center;
        }

        /* --- CONTE√öDO PRINCIPAL --- */
        main { 
            flex: 1; 
            padding: 30px; 
            padding-bottom: 100px; 
            overflow-y: auto; 
            position: relative; 
        }
        
        h2 { font-size: 1.8rem; margin-bottom: 20px; color: var(--text-main); border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        /* GRID DE PRODUTOS */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { 
            background: var(--bg-card); border-radius: 10px; overflow: hidden; 
            border: 1px solid var(--border); transition: transform 0.2s; display: flex; flex-direction: column;
        }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #333; }
        .card-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-price { color: var(--accent); font-size: 1.2rem; font-weight: bold; margin: 5px 0; }
        .card-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; flex: 1; }
        .card-actions { display: flex; gap: 10px; margin-top: auto; }
        
        /* PERFIL (DESKTOP PADR√ÉO) */
        .profile-header { 
            background: var(--bg-card); padding: 20px; border-radius: 10px; 
            margin-bottom: 20px; border: 1px solid var(--border); 
            display: flex; gap: 20px; align-items: flex-start; 
        }
        .profile-info-container { flex: 1; width: 100%; }
        .profile-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }

        /* --- MODAL DE DETALHES E AVALIA√á√ïES --- */
        #product-detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .modal-content {
            background: var(--bg-card); border-radius: 12px; width: 100%; max-width: 800px;
            padding: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }

        /* Estrelas */
        .rating-stars { font-size: 1.5rem; color: #ffc107; margin-bottom: 10px; }
        .rating-stars i { cursor: pointer; transition: color 0.2s; }
        .rating-stars i.far { color: var(--border); } /* Estrela vazia */
        .average-rating { font-size: 1.8rem; font-weight: bold; margin-bottom: 15px; color: var(--accent); }
        .review-form-area { 
            padding: 20px; 
            border: 1px solid var(--primary); 
            border-radius: 8px; 
            margin-top: 30px; 
            margin-bottom: 30px; 
            background: rgba(187, 134, 252, 0.05);
        }

        /* Revis√µes */
        .review-item { padding: 15px 0; border-top: 1px solid var(--border); }
        .review-item:first-child { border-top: none; }
        .review-user { font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .review-meta { font-size: 0.8rem; color: var(--text-muted); }
        .review-comment { margin-top: 5px; font-style: italic; }


        /* LOADING & TOAST */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 5px; background: transparent; z-index: 2000; }
        #loader.active { background: linear-gradient(90deg, var(--primary), var(--accent)); animation: load 1s infinite; }
        @keyframes load { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .toast { 
            position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: #000; 
            padding: 15px 25px; border-radius: 5px; font-weight: bold; 
            transform: translateY(100px); transition: 0.3s; z-index: 3000;
        }
        .toast.show { transform: translateY(0); }

        /* CHECKBOX */
        .checkbox-wrapper {
            display: flex; align-items: center; gap: 10px; background: #333; 
            padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border);
        }
        .checkbox-wrapper input { margin: 0; width: 20px; height: 20px; }

        /* --- MOBILE RESPONSIVO (CORRE√á√ïES) --- */
        @media(max-width: 768px) {
            body { flex-direction: column; height: 100vh; overflow: hidden; }
            
            aside { 
                width: 100%; height: 60px; flex-direction: row; flex-shrink: 0;
                justify-content: space-between; align-items: center; 
                padding: 0 15px; border-bottom: 1px solid var(--border); border-right: none;
            }

            /* Menu Dropdown Mobile */
            .nav-menu { 
                display: none; position: absolute; top: 60px; left:0; width:100%; 
                background: var(--bg-card); padding: 15px; z-index: 999; border-bottom: 1px solid var(--primary); 
                box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            }
            .nav-menu.mobile-open { display: block; }

            /* Header Mobile */
            .user-mini-profile { flex-direction: row; margin: 0; padding: 0; border: none; gap: 10px; }
            .avatar-circle { width: 35px; height: 35px; margin: 0; border-width: 2px; } 
            .user-name { font-size: 0.9rem; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } 
            .user-role { display: none; }
            
            .mobile-controls { display: flex; gap: 10px; align-items: center; } 
            #btn-search-toggle { width: 40px; height: 40px; font-size: 1.1rem; margin: 0; }
            #btn-search-toggle span { display: none; } 
            .mobile-toggle { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; border: 1px solid var(--border); border-radius: 6px; }

            /* CORRE√á√ÉO DO CONTE√öDO PRINCIPAL */
            main { 
                padding: 15px; 
                padding-bottom: 80px; 
                overflow-y: auto; 
                height: calc(100vh - 60px); 
            }

            /* CORRE√á√ÉO DA TELA DE PERFIL */
            .profile-header { 
                flex-direction: column; 
                align-items: center; 
                text-align: center;
                padding: 15px;
            }
            .profile-header img { margin-bottom: 15px; width: 80px; height: 80px; }
            
            .profile-form { 
                display: flex; 
                flex-direction: column; 
                gap: 0; 
                width: 100%;
            }
            .full-width { width: 100%; }
            
            /* CORRE√á√ÉO DO GRID DE PRODUTOS */
            .grid { 
                grid-template-columns: 1fr; 
            }
            
            /* Ajuste nos inputs do perfil para n√£o estourarem */
            input, textarea { width: 100%; box-sizing: border-box; }
        }

        @media(min-width: 769px) { 
            .mobile-toggle { display: none; } 
            .mobile-controls { display: none; }
        }
    </style>
</head>
<body>

    <div id="loader"></div>
    <div id="toast" class="toast">Notifica√ß√£o</div>

    <div id="auth-overlay">
        <div id="login-box" class="auth-box">
            <div class="auth-logo"><i class="fas fa-shopping-bag"></i> DarkMarket</div>
            <h3>Bem-vindo de volta</h3>
            <input type="text" id="l-user" placeholder="Usu√°rio">
            <input type="password" id="l-pass" placeholder="Senha">
            <button onclick="doLogin()" class="btn btn-primary" style="width:100%">Entrar na Conta</button>
            <p style="margin-top:15px; color:var(--text-muted); font-size:0.9rem">
                N√£o tem conta? <a href="#" onclick="toggleAuth()" style="color:var(--accent)">Cadastre-se</a>
            </p>
        </div>

        <div id="register-box" class="auth-box hidden">
            <div class="auth-logo"><i class="fas fa-user-plus"></i> Criar Conta</div>
            <input type="text" id="r-user" placeholder="Escolha um usu√°rio">
            <input type="password" id="r-pass" placeholder="Crie uma senha">
            
            <div class="checkbox-wrapper">
                <input type="checkbox" id="r-is-seller" onchange="toggleSellerInputs()">
                <label for="r-is-seller" style="cursor:pointer; color: #fff; font-weight: bold;">Quero vender produtos</label>
            </div>

            <div id="seller-inputs" class="hidden">
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px; text-align:left;">Dados de Pagamento (PIX/WPP s√£o obrigat√≥rios para vender):</p>
                <input type="text" id="r-pix" placeholder="Chave PIX">
                <input type="text" id="r-wpp" placeholder="WhatsApp (com DDD)">
            </div>

            <button onclick="doRegister()" class="btn btn-accent" style="width:100%">Criar Conta</button>
            <p style="margin-top:15px; color:var(--text-muted); font-size:0.9rem">
                J√° tem conta? <a href="#" onclick="toggleAuth()" style="color:var(--primary)">Fazer Login</a>
            </p>
        </div>
    </div>

    <div id="app-shell" class="hidden" style="display:contents">
        
        <aside>
            <div class="user-mini-profile">
                <img id="sb-avatar" src="https://via.placeholder.com/100" class="avatar-circle">
                <div class="user-name" id="sb-name">Usu√°rio</div>
                <div class="user-role" id="sb-role">Comprador</div>
            </div>
            
            <div class="mobile-controls">
                <button id="btn-search-toggle" onclick="toggleSearch()">
                    <i class="fas fa-search"></i>
                </button>
                <div class="mobile-toggle" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></div>
            </div>
            
            <nav class="nav-menu" id="nav-menu">
                <button onclick="navTo('shop')" id="btn-shop" class="active"><i class="fas fa-store"></i> Loja Global</button>
                <button onclick="navTo('sell')" id="nav-btn-sell" class="hidden"><i class="fas fa-plus-circle"></i> Anunciar Produto</button>
                <button onclick="navTo('profile')"><i class="fas fa-user-cog"></i> Meu Perfil</button>
                <div style="flex:1"></div> <button onclick="logout()" style="color:var(--danger)"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </nav>
        </aside>

        <main>
            <section id="view-shop">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>Loja Global</h2>
                    <button onclick="loadData()" class="btn btn-ghost"><i class="fas fa-sync"></i></button>
                </div>
                <div id="search-container" class="hidden" style="margin-bottom: 20px; display:flex; gap: 10px; align-items: center;">
                    <input type="text" id="search-term" placeholder="Buscar..." style="flex: 1; margin: 0;">
                    <button onclick="renderShop()" class="btn btn-primary" style="margin: 0;"><i class="fas fa-search"></i></button>
                </div>
                <div id="products-grid" class="grid"></div>
            </section>

            <section id="view-sell" class="hidden">
                <h2>Anunciar</h2>
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border:1px solid var(--border); max-width:600px">
                    <input type="text" id="p-name" placeholder="Nome do Produto">
                    <input type="text" id="p-img" placeholder="URL da Imagem">
                    <input type="number" id="p-price" placeholder="Pre√ßo (R$)">
                    <textarea id="p-desc" rows="4" placeholder="Descri√ß√£o..."></textarea>
                    <button onclick="postProduct()" class="btn btn-primary" style="width:100%">Publicar</button>
                </div>
            </section>

            <section id="view-profile" class="hidden">
                <h2>Meu Perfil</h2>
                <div class="profile-header">
                    <img id="prof-avatar-preview" src="" class="avatar-circle" style="width:100px; height:100px;">
                    <div class="profile-info-container">
                        <h3 style="margin-bottom:15px; color:var(--accent)">Editar Dados</h3>
                        <div class="profile-form">
                            <input type="text" id="edit-avatar" placeholder="URL Foto" onchange="previewAvatar(this.value)">
                            <input type="text" id="edit-user" placeholder="Usu√°rio" readonly style="opacity:0.5;">
                            
                            <input type="text" id="edit-pix" placeholder="Chave PIX" class="seller-only-field">
                            <input type="text" id="edit-wpp" placeholder="WhatsApp" class="seller-only-field">
                            
                            <textarea id="edit-bio" class="full-width" placeholder="Biografia..."></textarea>
                        </div>
                        <button onclick="updateProfile()" class="btn btn-accent" style="width:100%; margin-top:10px"><i class="fas fa-save"></i> Salvar</button>
                    </div>
                </div>
                <div id="seller-products-area"> 
                    <h3 style="margin-top:30px; padding-bottom:10px; border-bottom:1px solid #333">Meus Produtos</h3>
                    <div id="my-products-grid" class="grid" style="margin-top:15px"></div>
                </div>
            </section>

            <section id="view-seller-profile" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="seller-profile-name">Vendedor</h2>
                    <button onclick="navTo('shop')" class="btn btn-ghost"><i class="fas fa-arrow-left"></i></button>
                </div>
                <div id="seller-info" class="profile-header"></div>
                <h3 style="margin-top:30px; border-bottom:1px solid #333; padding-bottom:10px">Produtos √† venda</h3>
                <div id="seller-products-grid" class="grid" style="margin-top:15px"></div>
            </section>
        </main>
    </div>

    <div id="product-detail-modal" class="hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-product-name"></h2>
                <button onclick="closeProductDetail()" class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            
            <div style="display:flex; gap: 20px; flex-wrap: wrap;">
                <img id="modal-product-img" style="width: 100%; max-width: 300px; height: 300px; object-fit: cover; border-radius: 8px;">
                <div style="flex: 1; min-width: 250px;">
                    <p class="average-rating" id="modal-avg-rating"></p>
                    <p style="font-size: 1.5rem; color: var(--accent); font-weight: bold;" id="modal-product-price"></p>
                    <p style="color:var(--text-muted); margin-top: 10px;" id="modal-product-desc"></p>
                    <div style="margin-top: 20px;">
                        <span style="font-weight: bold; color: var(--primary);">Vendedor: </span>
                        <a href="#" id="modal-seller-link" style="color: var(--accent); text-decoration: none;"></a>
                    </div>
                </div>
            </div>

            <div class="review-form-area" id="review-form-area">
                <h4 style="margin-bottom: 10px; color: var(--primary);">Deixe sua Avalia√ß√£o</h4>
                <div id="rating-input" class="rating-stars">
                    <i class="far fa-star" data-rating="1"></i>
                    <i class="far fa-star" data-rating="2"></i>
                    <i class="far fa-star" data-rating="3"></i>
                    <i class="far fa-star" data-rating="4"></i>
                    <i class="far fa-star" data-rating="5"></i>
                </div>
                <textarea id="review-comment" rows="3" placeholder="Seu coment√°rio (opcional)"></textarea>
                <button onclick="submitReview()" class="btn btn-primary" style="width:100%"><i class="fas fa-paper-plane"></i> Enviar Avalia√ß√£o</button>
                <p id="review-status" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;"></p>
            </div>

            <h3 style="margin-top: 30px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">Avalia√ß√µes dos Compradores (<span id="review-count">0</span>)</h3>
            <div id="reviews-list">
                <p style="color:#777; margin-top:10px;">Ainda n√£o h√° avalia√ß√µes.</p>
            </div>
        </div>
    </div>


    <script>
        // CONFIG
        const BIN_ID = '691ab4a143b1c97be9b262b4'; 
        const API_KEY = '$2a$10$A5x.MiQYJZrXPO9rQ6OfXeOnX7Hvz2JMcb5ZJS78vGK8D3RJoVejy'; 
        const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        
        let globalData = { users: [], products: [] };
        let currentUser = null;
        let currentProductId = null;
        let currentRating = 0;

        function init() {
            const session = localStorage.getItem('darkUserProMobile'); 
            if(session) {
                currentUser = JSON.parse(session);
                showApp();
                loadData();
                // setupRatingInput ser√° chamado no final do script
            }
        }

        /* --- FUN√á√ïES DE DADOS E CONEX√ÉO --- */
        // ... (Todas as fun√ß√µes de dados e autentica√ß√£o permanecem inalteradas)
        async function loadData() {
            toggleLoader(true);
            try {
                const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
                if(!res.ok) throw new Error();
                const json = await res.json();
                globalData = json.record;
                if(currentUser) {
                    const u = globalData.users.find(x => x.user === currentUser.user);
                    if(u) {
                        currentUser = u;
                        if(!currentUser.role) currentUser.role = currentUser.pix ? 'seller' : 'buyer';
                        localStorage.setItem('darkUserProMobile', JSON.stringify(currentUser));
                        updateSidebarUI();
                    }
                }
                renderShop();
                if(!document.getElementById('view-profile').classList.contains('hidden')) renderProfilePage();
            } catch(e) { showToast("Erro de conex√£o"); }
            finally { toggleLoader(false); }
        }

        async function saveData() {
            toggleLoader(true);
            try {
                await fetch(URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify(globalData) });
                return true;
            } catch(e) { showToast("Erro ao salvar"); return false; }
            finally { toggleLoader(false); }
        }

        function toggleSellerInputs() {
            const check = document.getElementById('r-is-seller').checked;
            const div = document.getElementById('seller-inputs');
            check ? div.classList.remove('hidden') : div.classList.add('hidden');
        }

        async function doLogin() {
            const u = document.getElementById('l-user').value;
            const p = document.getElementById('l-pass').value;
            toggleLoader(true);
            await loadData();
            const found = globalData.users.find(x => x.user === u && x.pass === p);
            if(found) {
                currentUser = found;
                if(!currentUser.role) currentUser.role = currentUser.pix ? 'seller' : 'buyer';
                localStorage.setItem('darkUserProMobile', JSON.stringify(found));
                showApp();
                showToast("Bem-vindo!");
            } else showToast("Dados incorretos");
            toggleLoader(false);
        }

        async function doRegister() {
            const u = document.getElementById('r-user').value;
            const p = document.getElementById('r-pass').value;
            const isSeller = document.getElementById('r-is-seller').checked;
            
            if(!u || !p) return showToast("Preencha usu√°rio e senha");
            let pix='', wpp='';
            if(isSeller) {
                pix = document.getElementById('r-pix').value;
                wpp = document.getElementById('r-wpp').value;
                if(!pix || !wpp) return showToast("Vendedor precisa de PIX/WPP");
            }

            toggleLoader(true);
            await loadData();
            if(globalData.users.find(x => x.user === u)) { toggleLoader(false); return showToast("Usu√°rio j√° existe"); }
            
            globalData.users.push({
                user: u, pass: p, pix, wpp,
                role: isSeller ? 'seller' : 'buyer',
                avatar: 'https://ui-avatars.com/api/?name='+u+'&background=bb86fc&color=fff',
                bio: isSeller ? 'Vendedor novo.' : 'Comprador.'
            });

            if(await saveData()) { showToast("Criado! Fa√ßa login"); toggleAuth(); }
        }

        function logout() { localStorage.removeItem('darkUserProMobile'); window.location.reload(); }

        async function updateProfile() {
            const av = document.getElementById('edit-avatar').value;
            const px = document.getElementById('edit-pix').value;
            const wp = document.getElementById('edit-wpp').value;
            const bi = document.getElementById('edit-bio').value;

            toggleLoader(true);
            await loadData();
            const idx = globalData.users.findIndex(x => x.user === currentUser.user);
            if(idx !== -1) {
                if(av) globalData.users[idx].avatar = av;
                globalData.users[idx].pix = px; 
                globalData.users[idx].wpp = wp;
                globalData.users[idx].bio = bi;
                if(await saveData()) {
                    currentUser = globalData.users[idx];
                    localStorage.setItem('darkUserProMobile', JSON.stringify(currentUser));
                    updateSidebarUI();
                    showToast("Salvo!");
                }
            }
        }

        function renderProfilePage() {
            document.getElementById('edit-user').value = currentUser.user;
            document.getElementById('edit-pix').value = currentUser.pix || '';
            document.getElementById('edit-wpp').value = currentUser.wpp || '';
            document.getElementById('edit-bio').value = currentUser.bio || '';
            document.getElementById('edit-avatar').value = currentUser.avatar || '';
            document.getElementById('prof-avatar-preview').src = currentUser.avatar;

            const isSeller = currentUser.role === 'seller';
            const sellerFields = document.querySelectorAll('.seller-only-field');
            const sellerArea = document.getElementById('seller-products-area');

            if (isSeller) {
                sellerArea.classList.remove('hidden');
                sellerFields.forEach(field => field.classList.remove('hidden'));
            } else {
                sellerArea.classList.add('hidden');
                sellerFields.forEach(field => field.classList.add('hidden'));
                return; 
            }

            const myGrid = document.getElementById('my-products-grid');
            myGrid.innerHTML = '';
            const my = globalData.products.filter(p => p.seller === currentUser.user);
            
            if(!my.length) myGrid.innerHTML = '<p style="color:#777">Sem produtos.</p>';
            my.forEach(p => {
                myGrid.innerHTML += `
                    <div class="card">
                        <img src="${p.img}" class="card-img" onerror="this.src='https://via.placeholder.com/300'">
                        <div class="card-body">
                            <h4>${p.name}</h4>
                            <p class="card-price">R$ ${p.price}</p>
                            <button onclick="deleteProduct(${p.id})" class="btn btn-danger" style="margin-top:auto; width:100%"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }
        
        function renderShop() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            const term = document.getElementById('search-term').value.toLowerCase();
            let list = globalData.products;
            if(term) list = list.filter(p => p.name.toLowerCase().includes(term) || p.desc.toLowerCase().includes(term));
            
            list.slice().reverse().forEach(p => {
                const u = globalData.users.find(x => x.user === p.seller) || {};
                const av = u.avatar || 'https://ui-avatars.com/api/?name='+p.seller;
                const pix = u.pix || p.sellerPix;
                const wpp = u.wpp || p.sellerWpp;

                const avgRating = calculateAverageRating(p.reviews);
                const ratingHtml = getStarHTML(avgRating.score, 1);
                
                grid.innerHTML += `
                    <div class="card">
                        <img src="${p.img}" class="card-img" onclick="openProductDetail(${p.id})" style="cursor: pointer;" onerror="this.src='https://via.placeholder.com/300'">
                        <div class="card-body">
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px">
                                <img src="${av}" style="width:25px; height:25px; border-radius:50%">
                                <small onclick="renderSellerProfile('${p.seller}')" style="color:#aaa; cursor:pointer">${p.seller}</small>
                            </div>
                            <h3>${p.name}</h3>
                            <p class="card-price">R$ ${p.price}</p>
                            <p class="card-desc">${p.desc}</p>
                            <div style="margin-bottom: 10px; font-size: 0.9rem;">
                                ${ratingHtml} (${avgRating.count})
                            </div>
                            <div class="card-actions">
                                <button onclick="copy('${pix}')" class="btn btn-primary" style="flex:1" ${!pix ? 'disabled' : ''}>Pix</button>
                                <button onclick="window.open('https://wa.me/${wpp}')" class="btn btn-accent" style="flex:1" ${!wpp ? 'disabled' : ''}>Wpp</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function postProduct() {
            if(currentUser.role !== 'seller') return showToast("Apenas vendedores podem anunciar.");
            const n = document.getElementById('p-name').value;
            const i = document.getElementById('p-img').value;
            const pr = document.getElementById('p-price').value;
            const d = document.getElementById('p-desc').value;
            if(!n || !pr) return showToast("Nome e Pre√ßo obrigat√≥rios");
            
            toggleLoader(true);
            await loadData();
            
            globalData.products.push({ 
                id: Date.now(), 
                seller: currentUser.user, 
                name: n, img: i, price: pr, desc: d,
                sellerPix: currentUser.pix, 
                sellerWpp: currentUser.wpp,
                reviews: []
            });

            if(await saveData()) {
                showToast("Publicado!");
                document.getElementById('p-name').value='';
                document.getElementById('p-desc').value='';
                navTo('shop');
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Excluir?")) return;
            toggleLoader(true);
            await loadData();
            globalData.products = globalData.products.filter(p => p.id !== id);
            if(await saveData()) { showToast("Deletado"); renderProfilePage(); }
        }
        
        function renderSellerProfile(name) {
            const u = globalData.users.find(x => x.user === name);
            if(!u) return showToast("Vendedor n√£o encontrado");
            
            navTo('seller-profile');
            document.getElementById('seller-profile-name').innerText = name;
            
            const av = u.avatar || 'https://ui-avatars.com/api/?name='+name;
            document.getElementById('seller-info').innerHTML = `
                <img src="${av}" class="avatar-circle" style="width:80px; height:80px;">
                <div style="flex:1">
                    <h3 style="margin-bottom:5px">${name}</h3>
                    <p style="color:#aaa; font-size:0.9rem">${u.bio || 'Sem bio'}</p>
                    <div style="display:flex; gap:15px; font-size: 0.9rem; margin-top: 10px;">
                        <span style="color:var(--accent);"><i class="fas fa-qrcode"></i> PIX: ${u.pix ? 'Cadastrado' : 'N√£o Informado'}</span>
                        <span style="color:var(--accent);"><i class="fab fa-whatsapp"></i> WPP: ${u.wpp ? 'Cadastrado' : 'N√£o Informado'}</span>
                    </div>
                </div>
            `;
            const grid = document.getElementById('seller-products-grid');
            grid.innerHTML = '';
            const list = globalData.products.filter(p => p.seller === name);
            if(!list.length) grid.innerHTML = '<p>Sem produtos</p>';
            list.forEach(p => {
                const avgRating = calculateAverageRating(p.reviews);
                const ratingHtml = getStarHTML(avgRating.score, 1);
                
                grid.innerHTML += `
                <div class="card">
                    <img src="${p.img}" class="card-img" onclick="openProductDetail(${p.id})" style="cursor: pointer;" onerror="this.src='https://via.placeholder.com/300'">
                    <div class="card-body">
                        <h4>${p.name}</h4>
                        <p class="card-price">R$ ${p.price}</p>
                        <div style="margin-bottom: 10px; font-size: 0.9rem;">
                            ${ratingHtml} (${avgRating.count})
                        </div>
                        <div class="card-actions">
                            <button onclick="copy('${u.pix}')" class="btn btn-primary" style="flex:1" ${!u.pix ? 'disabled' : ''}>Pix</button>
                            <button onclick="window.open('https://wa.me/${u.wpp}')" class="btn btn-accent" style="flex:1" ${!u.wpp ? 'disabled' : ''}>Wpp</button>
                        </div>
                    </div>
                </div>`;
            });
        }


        /* --- FUN√á√ïES DO MODAL DE DETALHES E AVALIA√á√ïES --- */

        function getStarHTML(rating, size = 1) {
            let html = '';
            const roundedRating = Math.round(rating * 2) / 2;
            for (let i = 1; i <= 5; i++) {
                if (i <= roundedRating) {
                    html += `<i class="fas fa-star" style="font-size: ${size}rem;"></i>`;
                } else if (i - 0.5 === roundedRating) {
                    html += `<i class="fas fa-star-half-alt" style="font-size: ${size}rem;"></i>`;
                } else {
                    html += `<i class="far fa-star" style="font-size: ${size}rem;"></i>`;
                }
            }
            return html;
        }

        function calculateAverageRating(reviews) {
            if (!reviews || reviews.length === 0) return { score: 0, count: 0 };
            const total = reviews.reduce((sum, r) => sum + r.rating, 0);
            return {
                score: (total / reviews.length).toFixed(1),
                count: reviews.length
            };
        }
        
        // üåü FUN√á√ÉO DE CONFIGURA√á√ÉO DE EVENTOS DELEGADOS (MAIS ROBUSTA) üåü
        function setupRatingInput() {
            const ratingInput = document.getElementById('rating-input');
            
            if (!ratingInput) {
                console.warn("Elemento #rating-input n√£o encontrado para configurar eventos.");
                return; 
            }

            // Delega√ß√£o de evento de clique
            ratingInput.addEventListener('click', (event) => {
                const star = event.target.closest('i'); 
                if (star && star.hasAttribute('data-rating')) {
                    currentRating = parseInt(star.getAttribute('data-rating'));
                    highlightStars(currentRating);
                }
            });

            // Delega√ß√£o de evento de mouseover (para visualiza√ß√£o tempor√°ria)
            ratingInput.addEventListener('mouseover', (event) => {
                const star = event.target.closest('i');
                if (star && star.hasAttribute('data-rating')) {
                    highlightStars(parseInt(star.getAttribute('data-rating')));
                }
            });

            // Delega√ß√£o de evento de mouseout (para voltar ao estado selecionado)
            ratingInput.addEventListener('mouseout', () => {
                highlightStars(currentRating);
            });
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('#rating-input i');
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
        }

        function openProductDetail(id) {
            if (!currentUser) return showToast("Fa√ßa login para ver os detalhes e avaliar.");

            const product = globalData.products.find(p => p.id === id);
            if (!product) return showToast("Produto n√£o encontrado.");
            
            currentProductId = id;
            currentRating = 0; 
            
            document.getElementById('modal-product-name').innerText = product.name;
            document.getElementById('modal-product-img').src = product.img || 'https://via.placeholder.com/300';
            document.getElementById('modal-product-price').innerText = `R$ ${product.price}`;
            document.getElementById('modal-product-desc').innerText = product.desc;
            
            const sellerLink = document.getElementById('modal-seller-link');
            sellerLink.innerText = product.seller;
            sellerLink.onclick = () => { closeProductDetail(); renderSellerProfile(product.seller); };

            renderReviews(product.reviews);

            const existingReview = product.reviews.find(r => r.user === currentUser.user);
            const reviewFormArea = document.getElementById('review-form-area');
            const reviewStatus = document.getElementById('review-status');

            if (existingReview) {
                reviewFormArea.classList.add('hidden');
                reviewStatus.style.color = 'var(--accent)';
                reviewStatus.innerHTML = `Voc√™ j√° avaliou este produto em **${existingReview.rating} estrelas**.<br>Seu coment√°rio: "${existingReview.comment}"`;
            } else if (product.seller === currentUser.user) {
                reviewFormArea.classList.add('hidden');
                reviewStatus.style.color = 'var(--danger)';
                reviewStatus.innerText = "Voc√™ n√£o pode avaliar seu pr√≥prio produto.";
            } else {
                reviewFormArea.classList.remove('hidden');
                reviewStatus.innerText = '';
                document.getElementById('review-comment').value = '';
                highlightStars(0); // Garante que come√ßa com 0 estrelas selecionadas
            }

            document.getElementById('product-detail-modal').classList.remove('hidden');
        }

        function closeProductDetail() {
            document.getElementById('product-detail-modal').classList.add('hidden');
            currentProductId = null;
            currentRating = 0;
            highlightStars(0);
        }

        function renderReviews(reviews) {
            const reviewListDiv = document.getElementById('reviews-list');
            const avgRating = calculateAverageRating(reviews);

            document.getElementById('review-count').innerText = avgRating.count;
            document.getElementById('modal-avg-rating').innerHTML = `${avgRating.score} ${getStarHTML(avgRating.score, 1)} (${avgRating.count} avalia√ß√µes)`;
            
            reviewListDiv.innerHTML = '';

            if (reviews.length === 0) {
                reviewListDiv.innerHTML = '<p style="color:#777; margin-top:10px;">Ainda n√£o h√° avalia√ß√µes.</p>';
                return;
            }

            reviews.slice().reverse().forEach(r => {
                reviewListDiv.innerHTML += `
                    <div class="review-item">
                        <div class="review-meta">
                            ${getStarHTML(r.rating, 1)}
                            <span style="float:right;">${new Date(r.date).toLocaleDateString()}</span>
                        </div>
                        <div class="review-user">${r.user}</div>
                        <p class="review-comment">${r.comment || 'Nenhum coment√°rio.'}</p>
                    </div>
                `;
            });
        }

        async function submitReview() {
            if (!currentProductId) return;
            if (currentRating === 0) return showToast("Selecione de 1 a 5 estrelas!");
            
            const comment = document.getElementById('review-comment').value;
            
            toggleLoader(true);
            await loadData();
            
            const product = globalData.products.find(p => p.id === currentProductId);
            if (!product) { toggleLoader(false); return showToast("Produto n√£o encontrado."); }

            const existing = product.reviews.find(r => r.user === currentUser.user);
            if (existing) { toggleLoader(false); return showToast("Voc√™ j√° avaliou este produto."); }

            product.reviews.push({
                user: currentUser.user,
                rating: currentRating,
                comment: comment,
                date: Date.now()
            });

            if (await saveData()) {
                showToast("Avalia√ß√£o enviada!");
                openProductDetail(currentProductId); 
                renderShop(); 
            }
        }

        /* --- FUN√á√ïES DE NAVEGA√á√ÉO E UTILIT√ÅRIOS --- */
        // ... (Todas as fun√ß√µes utilit√°rias permanecem inalteradas)
        function navTo(screen) {
            ['view-shop','view-sell','view-profile','view-seller-profile'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            document.querySelectorAll('.nav-menu button').forEach(b=>b.classList.remove('active'));
            document.getElementById('view-'+screen).classList.remove('hidden');
            if(screen==='shop') document.getElementById('btn-shop').classList.add('active');
            if(screen==='sell') document.getElementById('nav-btn-sell').classList.add('active');
            if(screen==='profile') {
                document.querySelectorAll('.nav-menu button')[2].classList.add('active'); 
                renderProfilePage();
            }
            document.querySelector('.nav-menu').classList.remove('mobile-open');
            if(screen!=='shop') document.getElementById('search-container').classList.add('hidden');
        }

        function toggleSearch() {
            const s = document.getElementById('search-container');
            navTo('shop');
            s.classList.toggle('hidden');
        }
        function previewAvatar(url) { if(url) document.getElementById('prof-avatar-preview').src=url; }
        function showApp() { document.getElementById('auth-overlay').classList.add('hidden'); document.getElementById('app-shell').classList.remove('hidden'); updateSidebarUI(); }
        function updateSidebarUI() {
            document.getElementById('sb-name').innerText = currentUser.user;
            const btn = document.getElementById('nav-btn-sell');
            const lbl = document.getElementById('sb-role');
            if(currentUser.role === 'seller') { btn.classList.remove('hidden'); lbl.innerText='Vendedor'; lbl.style.color='var(--accent)'; }
            else { btn.classList.add('hidden'); lbl.innerText='Comprador'; lbl.style.color='#777'; }
            if(currentUser.avatar) document.getElementById('sb-avatar').src=currentUser.avatar;
        }
        function toggleAuth() { document.getElementById('login-box').classList.toggle('hidden'); document.getElementById('register-box').classList.toggle('hidden'); }
        function toggleMobileMenu() { document.querySelector('.nav-menu').classList.toggle('mobile-open'); }
        function toggleLoader(show) { const l=document.getElementById('loader'); show?l.classList.add('active'):l.classList.remove('active'); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        function copy(t) { if(!t) return showToast("Sem dado"); navigator.clipboard.writeText(t); showToast("Copiado"); }


        // üåü CHAMADA FINAL PARA GARANTIR QUE O DOM ESTEJA CARREGADO üåü
        document.addEventListener('DOMContentLoaded', () => {
            setupRatingInput(); // Inicializa a l√≥gica de eventos de clique nas estrelas
            init(); // Inicia o resto da aplica√ß√£o
        });
    </script>
</body>
</html>
